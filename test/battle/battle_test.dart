import 'dart:convert';

import 'package:conning_tower/models/data/data_model_adapter.dart';
import 'package:conning_tower/models/feature/kancolle/battle_info.dart';
import 'package:conning_tower/models/feature/kancolle/ship.dart';
import 'package:conning_tower/models/feature/kancolle/squad.dart';
import 'package:flutter_test/flutter_test.dart';

main() {
  group("Battle", () {

    // demo data.
    // make 12 ships
    List<Ship> ships = List.generate(12, (index) => Ship(uid: index, shipId: index, level: 1, nowHP: 100, maxHP: 100));

    test("Battle 2+4 VS 4", () {
      final inBattleSquads = [
        Squad(id: 1, name: "", ships: [ships[0], ships[1]]),
        Squad(id: 2, name: "", ships: [ships[2], ships[3], ships[4], ships[5]]),
      ];
      const rawData = """
      {"api_result":1,"api_result_msg":"成功","api_data":{"api_deck_id":1,"api_formation":[11,4,3],"api_f_nowhps":[69,57],"api_f_maxhps":[74,57],"api_f_nowhps_combined":[60,37,31,30],"api_f_maxhps_combined":[60,37,31,30],"api_fParam":[[67,0,82,76],[40,0,48,62]],"api_fParam_combined":[[73,70,70,75],[58,56,114,52],[60,82,82,52],[58,84,76,50]],"api_ship_ke":[1535,1535,1535,1534],"api_ship_lv":[50,50,50,50],"api_e_nowhps":[44,44,44,37],"api_e_maxhps":[44,44,44,37],"api_eSlot":[[1515,1515,1514,-1,-1],[1515,1515,1514,-1,-1],[1515,1515,1514,-1,-1],[1515,1515,1513,-1,-1]],"api_eParam":[[0,96,0,36],[0,96,0,36],[0,96,0,36],[0,86,0,30]],"api_smoke_type":0,"api_balloon_cell":0,"api_atoll_cell":0,"api_midnight_flag":0,"api_search":[1,5],"api_air_base_attack":[{"api_base_id":1,"api_stage_flag":[1,1,0],"api_plane_from":[null,null],"api_squadron_plane":[{"api_mst_id":480,"api_count":4},{"api_mst_id":459,"api_count":18},{"api_mst_id":404,"api_count":18},{"api_mst_id":484,"api_count":18}],"api_stage1":{"api_f_count":58,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0,"api_disp_seiku":1,"api_touch_plane":[480,-1]},"api_stage2":{"api_f_count":54,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0},"api_stage3":null},{"api_base_id":1,"api_stage_flag":[1,1,0],"api_plane_from":[null,null],"api_squadron_plane":[{"api_mst_id":480,"api_count":4},{"api_mst_id":459,"api_count":18},{"api_mst_id":404,"api_count":18},{"api_mst_id":484,"api_count":18}],"api_stage1":{"api_f_count":58,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0,"api_disp_seiku":1,"api_touch_plane":[-1,-1]},"api_stage2":{"api_f_count":54,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0},"api_stage3":null},{"api_base_id":2,"api_stage_flag":[1,1,0],"api_plane_from":[null,null],"api_squadron_plane":[{"api_mst_id":403,"api_count":18},{"api_mst_id":459,"api_count":18},{"api_mst_id":459,"api_count":18},{"api_mst_id":432,"api_count":18}],"api_stage1":{"api_f_count":72,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0,"api_disp_seiku":1,"api_touch_plane":[-1,-1]},"api_stage2":{"api_f_count":72,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0},"api_stage3":null},{"api_base_id":2,"api_stage_flag":[1,1,0],"api_plane_from":[null,null],"api_squadron_plane":[{"api_mst_id":403,"api_count":18},{"api_mst_id":459,"api_count":18},{"api_mst_id":459,"api_count":18},{"api_mst_id":432,"api_count":18}],"api_stage1":{"api_f_count":72,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0,"api_disp_seiku":1,"api_touch_plane":[-1,-1]},"api_stage2":{"api_f_count":72,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0},"api_stage3":null}],"api_stage_flag":[1,1,1],"api_kouku":{"api_plane_from":[[2],null],"api_stage1":{"api_f_count":18,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0,"api_disp_seiku":1,"api_touch_plane":[-1,-1]},"api_stage2":{"api_f_count":18,"api_f_lostcount":0,"api_e_count":0,"api_e_lostcount":0},"api_stage3":{"api_frai_flag":[0,0],"api_erai_flag":[0,0,0,0],"api_fbak_flag":[0,0],"api_ebak_flag":[0,0,0,0],"api_fcl_flag":[0,0],"api_ecl_flag":[0,0,0,0],"api_fdam":[0,0],"api_edam":[0,0,0,0],"api_f_sp_list":[null,null],"api_e_sp_list":[null,null,null,null]},"api_stage3_combined":{"api_frai_flag":[0,0,0,0],"api_fbak_flag":[0,0,0,0],"api_fcl_flag":[0,0,0,0],"api_fdam":[0,0,0,0],"api_f_sp_list":[null,null,null,null]}},"api_support_flag":0,"api_support_info":null,"api_opening_taisen_flag":1,"api_opening_taisen":{"api_at_eflag":[0,0,0,0],"api_at_list":[6,8,7,9],"api_at_type":[0,0,0,0],"api_df_list":[[2],[3],[1],[3]],"api_si_list":[["288"],["288"],["288"],["378"]],"api_cl_list":[[1],[0],[1],[0]],"api_damage":[[171.1],[0],[151.1],[0]]},"api_opening_flag":1,"api_opening_atack":{"api_frai_list_items":[null,null,null,null,null,null,null,null,null,null,null,null],"api_fcl_list_items":[null,null,null,null,null,null,null,null,null,null,null,null],"api_fdam":[0,0,0,0,0,0,0,25,0,0,0,0],"api_fydam_list_items":[null,null,null,null,null,null,null,null,null,null,null,null],"api_erai_list_items":[[6],null,null,[7],null,null,null],"api_ecl_list_items":[[0],null,null,[1],null,null,null],"api_edam":[0,0,0,0,0,0,0],"api_eydam_list_items":[[0],null,null,[25],null,null,null]},"api_hourai_flag":[1,0,0,0],"api_hougeki1":{"api_at_eflag":[0,0],"api_at_list":[6,8],"api_at_type":[0,0],"api_df_list":[[3],[0]],"api_si_list":[["288"],["288"]],"api_cl_list":[[1],[1]],"api_damage":[[184],[133]]}}}
      """;
      final json = jsonDecode(rawData);
      const path = "/api_req_combined_battle/battle";
      dynamic model = DataModelAdapter.toEntity(path, json);

      final battleInfo = BattleInfo();
      battleInfo.parseBattle(model.apiData!, inBattleSquads);
      expect(battleInfo.formation, 11);

    });

    test("Battle EC", () {
      final inBattleSquads = [
        Squad(id: 1, name: "", ships: [ships[0], ships[1], ships[2], ships[3], ships[4], ships[5]]),
      ];
      const rawData = """
  {"api_result":1,"api_result_msg":"成功","api_data":{"api_deck_id":1,"api_formation":[1,13,2],"api_f_nowhps":[71,60,53,24,34,80],"api_f_maxhps":[86,68,53,36,36,86],"api_fParam":[[86,0,84,94],[81,90,86,78],[81,88,71,74],[73,94,59,52],[61,89,72,52],[88,0,85,94]],"api_ship_ke":[1586,1615,1527,1592,1576,1576],"api_ship_lv":[1,1,1,1,1,1],"api_ship_ke_combined":[1555,1527,1575,1575,1575,1575],"api_ship_lv_combined":[1,1,1,1,1,1],"api_e_nowhps":[350,96,76,66,37,37],"api_e_maxhps":[350,96,76,66,37,37],"api_e_nowhps_combined":[57,76,35,35,35,35],"api_e_maxhps_combined":[57,76,35,35,35,35],"api_eSlot":[[1547,1548,1549,1532,-1],[1556,1557,1558,1558,-1],[1505,1506,1515,1525,-1],[1550,1550,1545,1525,-1],[1502,1545,1542,-1,-1],[1502,1545,1542,-1,-1]],"api_eSlot_combined":[[1506,1525,1542,1543,-1],[1505,1506,1515,1525,-1],[1502,1545,1542,-1,-1],[1502,1545,1542,-1,-1],[1502,1545,1542,-1,-1],[1502,1545,1542,-1,-1]],"api_eParam":[[180,0,130,150],[25,0,50,80],[68,48,40,70],[64,92,96,68],[38,66,32,26],[38,66,32,26]],"api_eParam_combined":[[48,80,30,39],[68,48,40,70],[38,60,30,22],[38,60,30,22],[38,60,30,22],[38,60,30,22]],"api_smoke_type":0,"api_balloon_cell":0,"api_midnight_flag":1,"api_search":[1,1],"api_air_base_attack":[{"api_base_id":1,"api_stage_flag":[1,1,1],"api_plane_from":[null,[1,2,3,4,7,8]],"api_squadron_plane":[{"api_mst_id":187,"api_count":18},{"api_mst_id":187,"api_count":18},{"api_mst_id":186,"api_count":18},{"api_mst_id":218,"api_count":18}],"api_stage1":{"api_f_count":72,"api_f_lostcount":20,"api_e_count":277,"api_e_lostcount":27,"api_disp_seiku":3,"api_touch_plane":[-1,1558]},"api_stage2":{"api_f_count":38,"api_f_lostcount":12,"api_e_count":0,"api_e_lostcount":0},"api_stage3":{"api_erai_flag":[0,0,1,0,0,0],"api_ebak_flag":[0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_edam":[0,0,44.1,0,0,0],"api_e_sp_list":[null,null,null,null,null,null]},"api_stage3_combined":{"api_erai_flag":[0,1,0,1,0,0],"api_ebak_flag":[0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_edam":[0,56,0,67,0,0],"api_e_sp_list":[null,null,null,null,null,null]}},{"api_base_id":1,"api_stage_flag":[1,1,1],"api_plane_from":[null,[1,2,3,4,7,8]],"api_squadron_plane":[{"api_mst_id":187,"api_count":18},{"api_mst_id":187,"api_count":18},{"api_mst_id":186,"api_count":18},{"api_mst_id":218,"api_count":18}],"api_stage1":{"api_f_count":72,"api_f_lostcount":20,"api_e_count":250,"api_e_lostcount":46,"api_disp_seiku":3,"api_touch_plane":[-1,1549]},"api_stage2":{"api_f_count":40,"api_f_lostcount":9,"api_e_count":0,"api_e_lostcount":0},"api_stage3":{"api_erai_flag":[0,0,0,1,0,0],"api_ebak_flag":[0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_edam":[0,0,0,58,0,0],"api_e_sp_list":[null,null,null,null,null,null]},"api_stage3_combined":{"api_erai_flag":[0,1,0,0,0,1],"api_ebak_flag":[0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_edam":[0,59,0,0,0,0],"api_e_sp_list":[null,null,null,null,null,null]}},{"api_base_id":2,"api_stage_flag":[1,1,1],"api_plane_from":[null,[1,2,3,4,7]],"api_squadron_plane":[{"api_mst_id":186,"api_count":18},{"api_mst_id":186,"api_count":18},{"api_mst_id":180,"api_count":18},{"api_mst_id":218,"api_count":18}],"api_stage1":{"api_f_count":72,"api_f_lostcount":11,"api_e_count":200,"api_e_lostcount":58,"api_disp_seiku":0,"api_touch_plane":[-1,1558]},"api_stage2":{"api_f_count":48,"api_f_lostcount":5,"api_e_count":0,"api_e_lostcount":0},"api_stage3":{"api_erai_flag":[0,0,0,0,1,1],"api_ebak_flag":[0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_edam":[0,0,0,0,0,89.1],"api_e_sp_list":[null,null,null,null,null,null]},"api_stage3_combined":{"api_erai_flag":[1,0,0,0,0,0],"api_ebak_flag":[0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_edam":[0,0,0,0,0,0],"api_e_sp_list":[null,null,null,null,null,null]}},{"api_base_id":2,"api_stage_flag":[1,1,1],"api_plane_from":[null,[1,2,3,4,7]],"api_squadron_plane":[{"api_mst_id":186,"api_count":18},{"api_mst_id":186,"api_count":18},{"api_mst_id":180,"api_count":18},{"api_mst_id":218,"api_count":18}],"api_stage1":{"api_f_count":72,"api_f_lostcount":11,"api_e_count":142,"api_e_lostcount":32,"api_disp_seiku":0,"api_touch_plane":[-1,-1]},"api_stage2":{"api_f_count":46,"api_f_lostcount":3,"api_e_count":0,"api_e_lostcount":0},"api_stage3":{"api_erai_flag":[0,0,1,0,0,0],"api_ebak_flag":[0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_edam":[0,0,71,0,0,0],"api_e_sp_list":[null,null,null,null,null,null]},"api_stage3_combined":{"api_erai_flag":[0,0,1,0,1,0],"api_ebak_flag":[0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_edam":[0,0,0,0,0,0],"api_e_sp_list":[null,null,null,null,null,null]}}],"api_stage_flag":[1,1,1],"api_kouku":{"api_plane_from":[[1,6],[1,2]],"api_stage1":{"api_f_count":86,"api_f_lostcount":5,"api_e_count":104,"api_e_lostcount":27,"api_disp_seiku":2,"api_touch_plane":[-1,-1]},"api_stage2":{"api_f_count":30,"api_f_lostcount":0,"api_e_count":59,"api_e_lostcount":36},"api_stage3":{"api_frai_flag":[0,1,0,0,0,0],"api_erai_flag":[0,0,0,0,0,0],"api_fbak_flag":[0,0,0,0,0,0],"api_ebak_flag":[0,0,0,1,0,0],"api_fcl_flag":[0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_fdam":[0,9,0,0,0,0],"api_edam":[0,0,0,0,0,0],"api_f_sp_list":[null,null,null,null,null,null],"api_e_sp_list":[null,null,null,null,null,null]},"api_stage3_combined":{"api_frai_flag":null,"api_erai_flag":[0,0,0,0,0,0],"api_fbak_flag":null,"api_ebak_flag":[0,0,0,0,0,1],"api_fcl_flag":null,"api_ecl_flag":[0,0,0,0,0,0],"api_fdam":null,"api_edam":[0,0,0,0,0,0],"api_f_sp_list":null,"api_e_sp_list":[null,null,null,null,null,null]}},"api_support_flag":0,"api_support_info":null,"api_opening_taisen_flag":0,"api_opening_taisen":null,"api_opening_flag":0,"api_opening_atack":null, "api_hourai_flag":[1,1,1,1],"api_hougeki1":{"api_at_eflag":[0,1,0],"api_at_list":[0,6,5],"api_at_type":[0,0,6],"api_df_list":[[10],[5],[6]],"api_si_list":[[328],[1506],["208","328","328"]],"api_cl_list":[[1],[0],[1]],"api_damage":[[83],[0],[123]]},"api_raigeki":{"api_frai":[-1,3,0,1,4,-1,-1],"api_fcl":[0,0,1,1,1,0,0],"api_fdam":[0,0,0,0,0,0,0],"api_fydam":[0,0,25,5,55,0,0],"api_erai":[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],"api_ecl":[0,0,0,0,0,0,0,0,0,0,0,0],"api_edam":[25,5,0,0,55.1,0,0,0,0,0,0,0],"api_eydam":[0,0,0,0,0,0,0,0,0,0,0,0]},"api_hougeki2":{"api_at_eflag":[0,1,0,0,0,0,0],"api_at_list":[0,0,5,2,1,4,3],"api_at_type":[2,0,6,2,0,0,0],"api_df_list":[[3,3],[2],[1],[0,0],[1],[0],[0]],"api_si_list":[["328","299"],[-1],["208","328","328"],["5","50"],[50],[122],[266]],"api_cl_list":[[1,2],[0],[1],[1,1],[1],[1],[1]],"api_damage":[[55,115],[0],[82.1],[1,23],[14],[27],[27]]},"api_hougeki3":{"api_at_eflag":[0,1,0,0,0,0,0],"api_at_list":[0,0,1,2,3,4,5],"api_at_type":[0,0,2,2,0,0,6],"api_df_list":[[0],[3],[0,0],[0,0],[0],[0],[0]],"api_si_list":[[328],[-1],["50","50"],["5","50"],[266],[122],["208","328","328"]],"api_cl_list":[[1],[0],[1,1],[1,1],[1],[0],[2]],"api_damage":[[2],[0],[28,25],[16,16],[19],[0],[107]]}}}
      """;
      final json = jsonDecode(rawData);
      const path = "/api_req_combined_battle/ec_battle";
      dynamic model = DataModelAdapter.toEntity(path, json);

      final battleInfo = BattleInfo();
      battleInfo.parseBattle(model.apiData!, inBattleSquads);
    });

    test("supportBattleRound", () {
      const rawData = """
      {"api_result":1,"api_result_msg":"\u6210\u529f","api_data":{"api_deck_id":3,"api_formation":[1,1,2],"api_f_nowhps":[53,31,31,48,34,38,74],"api_f_maxhps":[53,31,31,88,34,38,74],"api_fParam":[[60,73,90,67],[60,84,54,51],[65,92,47,52],[98,0,55,97],[53,73,67,52],[56,52,117,55],[17,0,58,60]],"api_ship_ke":[1707,1764,1592,1623,1577,1577],"api_ship_lv":[1,1,1,1,1,1],"api_e_nowhps":[550,84,66,46,38,38],"api_e_maxhps":[550,84,66,46,38,38],"api_eSlot":[[1563,1563,1515,1564,-1],[1556,1557,1558,1532,-1],[1550,1550,1545,1525,-1],[1502,1559,1544,-1,-1],[1502,1515,1542,-1,-1],[1502,1515,1542,-1,-1]],"api_eParam":[[170,90,86,199],[18,0,36,70],[64,92,96,68],[58,76,48,36],[44,72,36,29],[44,72,36,29]],"api_smoke_type":0,"api_balloon_cell":0,"api_atoll_cell":0,"api_midnight_flag":0,"api_search":[1,1],"api_stage_flag":[1,1,1],"api_kouku":{"api_plane_from":[[7],[2]],"api_stage1":{"api_f_count":54,"api_f_lostcount":6,"api_e_count":90,"api_e_lostcount":38,"api_disp_seiku":2,"api_touch_plane":[118,-1]},"api_stage2":{"api_f_count":30,"api_f_lostcount":17,"api_e_count":37,"api_e_lostcount":8},"api_stage3":{"api_frai_flag":[0,0,0,0,0,0,1],"api_erai_flag":[0,0,1,0,0,0],"api_fbak_flag":[0,0,0,0,0,0,1],"api_ebak_flag":[0,0,1,0,0,0],"api_fcl_flag":[0,0,0,0,0,0,0],"api_ecl_flag":[0,0,0,0,0,0],"api_fdam":[0,0,0,0,0,0,0],"api_edam":[0,0,82.1,0,0,0],"api_f_sp_list":[null,null,null,null,null,null,null],"api_e_sp_list":[null,null,null,null,null,null]}},"api_support_flag":2,"api_support_info":{"api_support_airatack":null,"api_support_hourai":{"api_deck_id":2,"api_ship_id":[747,15688,6038,659,10991,19197],"api_undressing_flag":[0,0,0,0,0,0],"api_cl_list":[1,1,0,1,1,0,0],"api_damage":[70,3,0,101,92.1,0,0]}},"api_opening_taisen_flag":0,"api_opening_taisen":null,"api_opening_flag":0,"api_opening_atack":null,"api_hourai_flag":[1,1,0,0],"api_hougeki1":{"api_at_eflag":[0,1,0,0,0,0,0,0],"api_at_list":[3,0,6,0,2,5,4,1],"api_at_type":[6,0,7,0,0,0,0,0],"api_df_list":[[5],[0],[1],[0],[0],[0],[0],[0]],"api_si_list":[["515","468","183"],[1563],["56","475","244"],[-1],[-1],[-1],[-1],[-1]],"api_cl_list":[[1],[0],[1],[1],[1],[1],[1],[0]],"api_damage":[[319],[0],[200.1],[42],[40],[52],[34],[0]]},"api_hougeki2":{"api_at_eflag":[0,1,0,0,0],"api_at_list":[0,0,1,2,3],"api_at_type":[0,0,0,0,2],"api_df_list":[[0],[0],[0],[0],[0,0]],"api_si_list":[[-1],[1563],[-1],[-1],["468","183"]],"api_cl_list":[[0],[0],[0],[0],[2,1]],"api_damage":[[0],[0],[0],[0],[299,108]]},"api_hougeki3":null,"api_raigeki":null}}      
      """;
      final inBattleSquads = [
        Squad(id: 1, name: "", ships: [ships[0], ships[1], ships[2], ships[3], ships[4], ships[5], ships[6]]),
      ];
      const path = "/api_req_sortie/battle";

      dynamic model = DataModelAdapter.toEntity(path, jsonDecode(rawData));

      final battleInfo = BattleInfo();
      battleInfo.parseBattle(model.apiData!, inBattleSquads);

      expect(battleInfo.inBattleSquads, inBattleSquads);
    });
  });
}